# Поведение клиентов

## Дано
Дана следующая структура таблиц:

![Схема базы](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database20.png)

## Задание
Вам необходимо провести анализ поведения клиентов. Он должен содержать следующую информацию:

- ID покупателя
- Общую сумму продаж для каждого клиента, округленную до целого числа (```total_sales```)
- Среднее количество товаров, приобретенных каждым клиентом (```avg_quantity```)
- Дату самого последнего заказа для каждого клиента (```recent_order_date```)
Результат отсортируйте по общей сумме продаж в порядке убывания.

## Столбцы в результате

- ```id_customer```
- ```total_sales```
- ```avg_quantity```
- ```recent_order_date```

## Решение 1
``` SQL
SELECT 
  DISTINCT id_customer, 
  ROUND(SUM(total_price) OVER(PARTITION BY id_customer))::INT AS total_sales, 
  ROUND(AVG(quantity) OVER(PARTITION BY id_customer), 2) AS avg_quantity, 
  FIRST_VALUE(date_order) OVER(
    PARTITION BY id_customer 
    ORDER BY 
      date_order DESC
  ) AS recent_order_date
FROM 
  C_ORDERS o 
  JOIN ORDER_DETAILS USING(id_orders)
ORDER BY total_sales DESC
```

## Решение 2
``` SQL
SELECT
  o.id_customer,
  ROUND(SUM(od.total_price))::INT as total_sales,
  ROUND(AVG(od.quantity), 2) as avg_quantity,
  MAX(o.date_order) AS recent_order_date
FROM c_orders o
JOIN order_details od ON od.id_orders = o.id_orders
GROUP BY o.id_customer
ORDER BY total_sales DESC
```