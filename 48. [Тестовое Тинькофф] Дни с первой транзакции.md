# [Тестовое Тинькофф] Дни с первой транзакции

## Задача
Для каждой транзакции посчитать количество дней, которые прошли успешно с момента первой транзакции по этому клиенту. Проставить флаг, относится ли транзакция к клиенту, начавшему обслуживаться в банке в 2023 году.

## Столбцы в результате

- ```transaction_id```
- ```customer_id```
- ```amount_rur```
- ```transaction_dttm```
- ```days_count```
- ```new_cust_flg```

## Используемые таблицы

**Таблица ```TRANSACTION_TIN```**
| Столбец      | Тип данных |Описание                         |
|:-|:-|:-|
| transaction_id   | int            | Идентификатор транзакции             |
| customer_id      | int            | Идентификатор клиента                |
| amount_rur       | float          | Сумма транзакции в российских рублях |
| transaction_dttm | datetime       | Дата и время транзакции              |
| success_flg      | bool           | Флаг успешной транзакции (TRUE)      |

**Таблица ```CUSTOMER_TIN```**

**Столбец**		**Тип данных**		**Описание**  
customer_id		int					Идентификатор клиента  
name			varchar				Имя клиента  
start_dttm		datetime			Дата и время начала обслуживания клиента  
birth_dt		date				Дата рождения клиента  

Таблицы находятся в схеме ```interview```.

## Решение
``` SQL
WITH first_success_transaction AS (
  SELECT 
    customer_id, 
    MIN(transaction_dttm) AS first_transaction_dttm
  FROM 
    interview.TRANSACTION_TIN 
  WHERE 
    success_flg = TRUE 
  GROUP BY 
    customer_id
) 
SELECT 
  transaction_id,
  customer_id, 
  amount_rur, 
  transaction_dttm, 
  (transaction_dttm::DATE - first_transaction_dttm::DATE)::NUMERIC AS days_count, 
  EXTRACT(YEAR FROM start_dttm) = 2023 AS new_cust_flg 
FROM 
  interview.TRANSACTION_TIN t 
  JOIN first_success_transaction s USING(customer_id) 
  JOIN interview.CUSTOMER_TIN USING(customer_id)
  WHERE t.success_flg = TRUE
  ORDER BY t.transaction_id;
```