# Проверить падение продаж 3 года подряд

## Дано
Дана следующая структура таблиц:

![структура таблиц](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database43.png)

## Задание
Помесячно проверить: если суммарное количество продаж в течение трех месяцев подряд падают, то вывести в столбец ```Result``` значение ```1```, иначе ```0```.

## Столбцы в результате
- ```year``` - год
- ```month``` - месяц
- ```prev2_cnt``` - кол-во продаж за позапрошлый месяц
- ```prev_cnt``` - кол-во продаж за прошлый месяц
- ```cur_cnt``` - кол-во продаж за текущий месяц
- ```result``` - результат (0 или 1)

**Важно:** Обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

## Сортировка
Результат отсортируйте по возрастанию столбцов ```year```, ```month```.

## Решение
``` SQL
WITH sales AS (
  SELECT 
    TO_CHAR(o.ord_datetime, 'YYYY') AS year, 
    TO_CHAR(o.ord_datetime, 'MM') AS month, 
    LAG(
      COUNT(*), 
      2
    ) OVER(
      ORDER BY
        TO_CHAR(o.ord_datetime, 'YYYY'),
        TO_CHAR(o.ord_datetime, 'MM')
    ) AS prev2_cnt, 
    LAG(
      COUNT(*)
    ) OVER(
      ORDER BY
        TO_CHAR(o.ord_datetime, 'YYYY'),
        TO_CHAR(o.ord_datetime, 'MM')
    ) AS prev_cnt, 
    COUNT(*) AS cur_cnt 
  FROM 
    Orders o 
    JOIN Analysis a ON o.ord_an = a.an_id 
  GROUP BY 
    TO_CHAR(o.ord_datetime, 'YYYY'), 
    TO_CHAR(o.ord_datetime, 'MM') 
  ORDER BY 
    year, 
    month
) 
SELECT 
  *, 
  CASE WHEN prev_cnt > cur_cnt 
  AND prev2_cnt > prev_cnt THEN 1 ELSE 0 END AS result 
FROM 
  sales
```