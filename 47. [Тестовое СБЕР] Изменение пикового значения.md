# [Тестовое СБЕР] Изменение пикового значения

## Задача
Определить, как менялось пиковое значение по ежедневному количеству регистраций на платформе.

**Период Анализа:**

Рассматриваем период с ```01.01.2022``` и последующие ```110``` дней.

## Данные
Структура таблицы users: ```SELECT * FROM users```

## Столбцы для вывода

- ```dt``` - дата.
- ```cnt``` - количество зарегистрировавшихся в день пользователей.
- ```max_cnt``` - максимальное количество регистраций за все предыдущие дни.
- ```diff``` - разница между количеством зарегистрировавшихся пользователей в определенный день и максимальным количеством регистраций за все предыдущие дни.

**Примечания:**

- необходимо учесть дни без регистраций.
- если регистраций не было, то выведите 0.

**Важно:** обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

**Сортировка:** результат отсортируйте по возрастанию ```dt```.

## Решение
### CTE Calendar:
Чтобы иметь полный период для анализа с помощью функции ```generate_series``` генерируем календарь с датами, начиная с ```2022-01-01``` и добавляя ```110``` дней.

### CTE Registrations:
Необходимо получить количество регистрация для каждого дня. Для этого группируем регистрации по дням, используя функцию ```date_trunc``` для округления времени до начала дня (```day```).

### Main Query:
Для того, чтобы включить дни без регистраций объединяем календарь с регистрациями по дате с использованием левого соединения. С использованием оконной функции max находим максимальное количество регистраций за все предыдущие дни.
Чтобы учесть дни без регистраций с помощью функции ```coalesce``` заменяем ```null```-значения на ```0```
Разница между текущим количеством зарегистрировавшихся пользователей в определенный день и максимальным количеством регистраций за все предыдущие дни показывает, как менялось пиковое значение.

``` SQL
WITH calendar AS (
  SELECT 
    CAST('2022-01-01' as date) + (n || 'day'):: interval AS dt 
  FROM 
    generate_series(0, 110) n
), 
registrations AS(
  SELECT 
    DATE_TRUNC('day', date_joined) AS day, 
    COUNT(*) AS cnt
  FROM 
    users 
  GROUP BY day
) 
SELECT 
  c.dt :: DATE, 
  COALESCE(r.cnt, 0) AS cnt, 
  max(cnt) OVER(
    ORDER BY 
      dt
  ) AS max_cnt, 
  COALESCE(r.cnt, 0) - MAX(cnt) OVER(
    ORDER BY 
      dt
  ) AS diff 
FROM 
  calendar c 
  LEFT JOIN registrations r ON c.dt = r.day 
ORDER BY 
  c.dt
```