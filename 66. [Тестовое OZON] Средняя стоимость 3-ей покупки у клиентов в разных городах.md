# [Тестовое OZON] Средняя стоимость 3-ей покупки у клиентов в разных городах

```Эта задача взята из тестового задания на позицию стажер-аналитик в Ozon```

## Дано
Дана следующая схема таблиц:

![структура таблиц](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database1.png)

## Задание
Требуется вывести среднюю стоимость 3-ей покупки у клиентов в разных городах.

### Примечания:

- поле со стоимостью 3-ей покупки назовите ```avg_price_3th_purchase``` и округлите до 2-х знаков после запятой.
- если покупки были совершены в одну и ту же дату, предполагается, что меньший идентификатор покупки соответствует более ранней покупке.

## Выводимые столбцы
- ```city``` - город клиента
- ```avg_price_3th_purchase``` - средняя стоимость 3-ей покупки

**Важно:** обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

**Примечание:** для корректной работы вашего запроса обязательно указывайте схему таблиц - ```ozon```. Например, ```FROM ozon.users```.

## Решение
``` SQL
WITH price_3th_purchase AS (
  SELECT 
    city, 
    price, 
    ROW_NUMBER() OVER(
      PARTITION BY city, user_id 
      ORDER BY 
        p.created_at, p.id
    ) AS rank 
  FROM 
    ozon.purchases p 
    JOIN ozon.users u ON p.user_id = u.id 
    JOIN ozon.skus s ON s.id = p.sku_id
) 
SELECT 
  city, 
  AVG(price) AS avg_price_3th_purchase 
FROM 
  price_3th_purchase 
WHERE 
  rank = 3
GROUP BY city
```