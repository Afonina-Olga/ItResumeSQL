# Тенденции покупательной способности

## Дано
Дана следующая структура таблиц:

![Схема базы](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database20.png)

## Задание
Вам поручили проанализировать тенденции покупательной способности клиентов за первое полугодие 2021 года (с января по июнь включительно). Компания хочет отследить увеличение суммы заказов по клиентам, чтобы выявить причины и принять верные решения в области ценообразования.

Вам необходимо отразить нарастающий итог по сумме заказов для каждого клиента. А также, найти насколько увеличивалась сумма каждого нового заказа клиента относительно суммы уже совершенных заказов.

Напишите запрос, который выведет сводную информацию по каждому клиенту за первое полугодие 2021 года.

## Столбцы в результате

- ```date_order``` - дата заказа;
- ```id_customer``` - id клиента;
- ```price``` - сумма заказа;
- ```orders_running_total``` - нарастающий итог по заказам;
- ```orders_increase``` - прирост суммы заказа (в процентах), округленный до двух знаков после запятой, в формате +XXXX.XX%.

## Требования к сортировке

Отсортируйте результат в порядке возрастания ```id``` клиента, а затем по возрастанию даты.

## Пример результирующей таблицы

| date_order | id_customer | price | orders_running_total | orders_increase |
|------------|-------------|-------|----------------------|-----------------|
| 2021-01-10 | 15 | 1198 | 1198 | null |
| 2021-01-18 | 15 | 786 | 1984 | +65.61% |
| 2021-02-18 | 15 | 412 | 2396 | +20.77% |
| 2021-02-24 | 15 | 1012 | 3408 | +42.24% |

## Решение
``` SQL
WITH cte AS(
  SELECT 
    date_order :: DATE, 
    id_customer, 
    price, 
    SUM(price) OVER(
      PARTITION BY id_customer 
      ORDER BY 
        date_order
    ) AS orders_running_total 
  FROM 
    C_ORDERS 
  WHERE 
    EXTRACT(
      QUARTER 
      FROM 
        date_order
    ) in (1, 2)
) 
SELECT 
  *, 
  '+' || ROUND(
    price::NUMERIC / LAG(orders_running_total) OVER(
      PARTITION BY id_customer 
      ORDER BY 
        date_order
    ) * 100, 
    2
  ) || '%' AS orders_increase 
FROM 
  cte 
ORDER BY 
  id_customer, 
  date_order

```
