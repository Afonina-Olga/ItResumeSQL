# Прирост продаж для анализов с условием

## Дано
Дана следующая структура таблиц:

![структура таблиц](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database1.png "Схема БД")

## Задание
Помесячно вывести прирост количества продаж в процентах относительно предыдущего месяца для всех анализов в 2020 году, где в названии в любом месте располагается слово ```"кров"``` или ```"тестостерон"``` в любом регистре.

**Примечание.** Величину ```change``` округлите до 3 знака после запятой. В случае ```NULL``` выведите 0.

## Столбцы в результате
- ```name``` - название анализа
- ```month``` - месяц
- ```current_cnt``` - продажи за текущий месяц
- ```prev_cnt``` - продажи за предыдущий месяц
- ```change``` - прирост в процентах

**Важно:** Обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

## Сортировка
Результат отсортируйте по возрастанию столбцов ```name```, ```month```.

## Решение
``` SQL
WITH sales AS (
  SELECT 
    an_name AS name, 
    TO_CHAR(ord_datetime, 'MM') AS month, 
    COUNT(ord_an) AS current_cnt 
  FROM 
    Orders o 
    JOIN Analysis a ON o.ord_an = a.an_id 
  WHERE 
    (
      LOWER(an_name) LIKE '%кров%' 
      OR LOWER(an_name) LIKE '%тестостерон%'
    ) 
    AND EXTRACT(
      YEAR 
      FROM 
        ord_datetime
    ) = 2020 
  GROUP BY 
    TO_CHAR(ord_datetime, 'MM'), 
    an_name
), 
prev AS(
  SELECT 
    name, 
    month, 
    current_cnt, 
    LAG(current_cnt) OVER(
      PARTITION BY name 
      ORDER BY 
        month
    ) AS prev_cnt 
  FROM 
    sales 
  ORDER BY 
    name, 
    month
) 
SELECT 
  *, 
  ROUND(
    COALESCE(
      (current_cnt - prev_cnt):: NUMERIC /(prev_cnt)* 100, 
      0
    ), 
    3
  ) AS change 
FROM 
  prev

```