# Объем продаж по кварталам

## Дано
Дана следующая структура таблиц:

![Схема базы](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database20.png)

## Пролог
Таблицы содержат информацию о продажах, покупателях и наличии товаров. Чтобы опережать конкурентов и принимать взвешенные решения, будет важно знать, какие продукты являлись лидерами продаж в прошедших кварталах. Эта информация позволит принимать решения об объемах и составе будущих поставок, а также о том, какие товары, возможно, потребуется исключить вовсе.

## Задание
Напишите запрос, который выведет топ-5 продуктов с самыми высокими продажами за каждый квартал.

Объем продаж рассчитывается по столбцу ```quantity``` - как количество проданных товаров.

## Столбцы в результате

- ```quarter``` - первый день квартала в формате date
- ```product``` - id продукта
- ```total_sales``` - количество проданных позиций

## Требования к сортировке
Результат отсортируйте по кварталу и по объему продаж в порядке убывания. К тому же, если в каком-либо из кварталов имеются товары с одинаковым объемом продаж - расположите их в порядке возрастания ```id_product```.

## Решение
``` SQL
WITH sales AS(
  SELECT 
    id_product AS product, 
    SUM(quantity) AS total_sales, 
    DATE_TRUNC('quarter', o.date_order):: DATE AS quarter 
  FROM 
    C_ORDERS o 
    JOIN ORDER_DETAILS od USING(ID_ORDERS) 
  GROUP BY 
    id_product, 
    DATE_TRUNC('quarter', o.date_order):: DATE
), 
rank AS(
  SELECT 
    *, 
    ROW_NUMBER() OVER (
      PARTITION BY quarter 
      ORDER BY 
        total_sales DESC, 
        product
    ) AS rank
  FROM sales
) 
SELECT 
  quarter, 
  product, 
  total_sales 
FROM 
  rank 
WHERE 
  rank <= 5 
ORDER BY 
  quarter, 
  total_sales DESC, 
  product
```