# Медианные суммы заказов

## Дано
Дана следующая структура таблиц:

![структура таблиц](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database1.png "Схема БД")

## Задание
Необходимо рассчитать медианное значение суммы заказов в разрезе года и месяца. Медиана должна быть рассчитана в 2 вариантах:

- ```интерполированная медиана```: в качестве медианы берется сумма, которая делит все заказы ровно в 50% пропорции, даже если фактически такого заказа на было.

- ```действительная медиана```: в качестве медианы берется реальная сумма заказа. Если заказов четное число, то берется ближайшая сумма заказа, меньшая интерполированной медианы.

**Пример:**

```
Дано: 1; 2
Интерполированная медиана: 1.5
Действительная медиана: 1
```

**Важно:** Одним заказом считаем строки из таблицы ```Orders``` в которых полностью совпадает поле ```ord_datetime```.

## Сортировка
Результат отсортируйте по возрастанию года-месяца.

## Столбцы в результате
- ```dt``` - год и месяц
- ```interpolated_median``` - интерполированная медиана
- ```real_median``` - действительная медиана

**Важно:** Обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

## Дополнительные условия
- Столбец ```dt``` должен быть представлен в виде строки в формате ```YYYY-MM```
- Столбцы с медианами должны иметь тип ```numeric```

# Решение
``` SQL
WITH sales AS (
  SELECT 
    ord_datetime, 
    SUM(an_price) AS price 
  FROM 
    analysis a 
    JOIN orders o ON o.ord_an = a.an_id 
  GROUP BY 
    ord_datetime
) 
SELECT 
  TO_CHAR(ord_datetime, 'YYYY-MM') as dt, 
  PERCENTILE_CONT(0.5) WITHIN GROUP (
    order by 
      price
  ) as interpolated_median, 
  PERCENTILE_DISC(0.5) WITHIN GROUP (
    order by 
      price
  )::NUMERIC as real_median 
FROM 
  sales 
GROUP BY dt
```