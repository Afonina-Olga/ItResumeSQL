# Построить когорту

## Дано
Дана следующая структура таблиц:

![Схема базы](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database20.png)

## Задание
Построить когорты по месяцу первой покупки и месяцам последующих покупок.

**Когорта** — это группа людей, которых объединяет один или несколько признаков. В данном случае их объединяют покупки в одном магазине. С помощью когортного анализа можно оценить эффективность каналов привлечения, повысить активность покупателя, посмотреть как долго клиент пользуется нашим товаром и многое другое.

Для решения задачи нам понадобится таблица ```C_ORDERS```.

Нам надо найти количество клиентов, которые совершили первую покупку в один и тот же месяц, а затем смотреть, сколько пользователей сделали покупки в последующие месяца.

## Столбцы в результате

- ```count_user```
- ```month_first_order```
- ```month_order```
- ```month_diff```

**Важно:** Обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

### Пример итогового результата:

| count_user | month_first_order | month_order	month_diff |
|------------|-------------------|-------------------------|
| 21 | 2021-01-01 00:00:00 | 2021-01-01 00:00:00 | 0 |
| 14 | 2021-01-01 00:00:00 | 2021-02-01 00:00:00 | 1 |
| 17 | 2021-01-01 00:00:00 | 2021-03-01 00:00:00 | 2 |
| 4 | 2021-02-01 00:00:00 | 2021-02-01 00:00:00 | 0 |

Количество клиентов, которые сделали свою первую покупку в январе 2021 года - 21. Из них 14 клиентов совершили повторную покупку в следующий месяц. А еще через месяц 17 клиентов что-то купили. В феврале 2021 года свои первые покупки сделало 4 человека.

## Решение
``` SQL
WITH users AS (
  SELECT 
    id_orders, 
    id_customer, 
    DATE_TRUNC('month', date_order) AS month_order, 
    DATE_TRUNC(
      'month', 
      FIRST_VALUE(date_order) OVER(
        PARTITION BY id_customer 
        ORDER BY 
          date_order
      )
    ) AS month_first_order 
  FROM 
    C_ORDERS
) 
SELECT 
  COUNT(DISTINCT id_customer) AS count_user,
  month_first_order, 
  month_order, 
  EXTRACT(
    MONTH 
    FROM 
      AGE(month_order, month_first_order)
  ) AS month_diff 
FROM 
  users 
GROUP BY 
  month_order, 
  month_first_order, 
  month_diff
```

## Алгоритм решения

1. Для каждого клиента необходимо определить первый месяц покупки

2. Т.к. когорты необходимо построить по месяцам, следует преобразовать даты покупок в месяца и найти разности между месяцем покупок и месяцем первой покупки для каждого клиента

3. Считаем количество пользователей, совершивших покупки в каждом месяце

4. Отсортируем сначала по месяцу первой покупки, затем по месяцу покупки

``` SQL
select -- считаем количество пользователей, 
       --совершивших покупки в каждом месяце
    count(distinct id_customer) as count_user,
    month_first_order,
    month_order,
    month_diff
from ( 
-- преобразовываем даты покупок в месяца 
-- и находим разность между месяцем покупок и месяцем первой покупки
    select id_customer,
        date_trunc('month', date_order) as month_order,
        date_trunc('month', first_date) as month_first_order,

        (date_part('year', date_order) - date_part('year', first_date)) * 12 + 
        (date_part('month', date_order) - date_part('month', first_date)) 
        as month_diff
    from (
-- определяем первый месяц покупки
        select a.id_customer, 
            first_value(a.date_order) 
            over (partition by a.id_customer order by a.date_order) as first_date,
            a.date_order
        from c_orders a
        ) b
    ) c
group by month_first_order, month_order, month_diff
order by month_first_order, month_order -- сортируем данные
```