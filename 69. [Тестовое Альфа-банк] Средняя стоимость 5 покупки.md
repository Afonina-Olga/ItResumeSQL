# [Тестовое Альфа-банк] Средняя стоимость 5 покупки

```
Эта задача взята из тестового задания на позицию Аналитика в Альфа-банк
```

## Дано
Дана следующая структура таблиц:

![структура таблиц](https://github.com/Afonina-Olga/ItResumeSQL/blob/main/img/database17.png)

## Задание
Необходимо вывести среднюю стоимость 5-ой покупки с разбивкой по городам.

**Примечание.** Если один и тот же человек совершал покупки, но в разное время, то это считаем за разные покупки.

## Столбцы в результате
- ```town```
- ```avg_price_5th_purchase``` - столбец с рассчитанной средней стоимостью

**Важно:** Обратите внимание, что название столбцов в вашем ответе должно в точности совпадать с условием.

## Сортировка
**Важно:** Результат должен быть отсортирован по убыванию значений в столбце ```avg_price_5th_purchase```.

## Решение
``` SQL
WITH cte AS (
  SELECT 
  town,
  price,
  ROW_NUMBER() OVER(
    PARTITION BY town, id_customer
    ORDER BY 
      created_at, p.id
  ) AS rank
FROM 
  purchases p 
  JOIN customer c ON p.user_id = c.id_customer
  JOIN skus s ON s.id = p.sku_id
)
SELECT 
  town, 
  AVG(price) AS avg_price_5th_purchase 
FROM 
  cte 
WHERE 
  rank = 5
GROUP BY town
ORDER BY avg_price_5th_purchase DESC
```